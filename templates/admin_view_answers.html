

{% extends "base.html" %}
{% block title %}ADMINISTRATORS{% endblock %}
{% block sidebar %}
<div class="container-fluid add-admin text-center py-3">
  <a href="{{ url_for('admin_create_checklist') }}" class="btn btn-dark btn-sm my-1">
      <i class="fas fa-clipboard-list me-2"></i>CREATE CHECKLIST FOR OPERATOR
  </a>
  <a href="{{ url_for('admin_create_question') }}" class="btn btn-dark btn-sm my-1">
      <i class="fas fa-plus-circle me-2"></i>CREATE QUESTIONS
  </a>
  <a href="{{ url_for('admin_delete_question') }}" class="btn btn-dark btn-sm my-1">
      <i class="fas fa-trash-alt me-2"></i>DELETE QUESTIONS
  </a>
  
 <!-- <a href="{{ url_for('admin_view_answers') }}" class="btn btn-secondary btn-sm my-1">
    <i class="fas fa-clipboard-list me-2"></i>VIEW ANSWERS
</a>

<a href="{{ url_for('admin_view_unanswered_questions') }}" class="btn btn-dark btn-sm my-1">
    <i class="fas fa-edit me-2"></i>UNANSWERED QUESTIONS
</a>-->
</div>
{% endblock %}
{% block content %}

    <div class="container mt-5">
        <h1 class="text-center">Answers</h1>
       
        <!-- Filter Section -->
        <div class="mb-3">
            <form method="POST" action="{{ url_for('admin_view_answers') }}">
                <label class="form-label">Filter Section</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-filter"></i>
                    </span>
                    <select class="form-select" name="section" id="section">
                        <option value="">-- All Sections --</option>
                        {% for item in plant_sections %}
                            <option value="{{ item.plant_section }}" {% if selected_section == item.plant_section %}selected{% endif %}>
                                {{ item.plant_section | upper }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Filter</button>
                </div>
            </form>
        </div>
    
        <!-- Display Answers -->
        {% if answers %}
            {% for answer in answers %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Plant Section: {{ answer.plant_section }}</h3>
                        <p><strong>Operator:</strong> {{ answer.operator }}</p>
                        <p><strong>Timestamp:</strong> {{ answer.time_stamp }}</p>
                    </div>
                    <div class="card-body">
                        <h4>Questions and Answers:</h4>
                        <div>
                            <p><strong>Question:</strong> {{ checklist_answers }}</p>
                            {% for reply in checklist_answers %}
                            <p><strong>Question:</strong> {{ reply.question }}</p>
                            <p><strong>Answer:</strong> {{ reply.answer }}</p>
                            {% if reply.reason %}
                            <p><strong>Reason:</strong> {{ reply.reason }}</p>
                            {% endif %}
                            {% endfor %}
                            
                        </div>
                        <div class="location-info">
                            <h4>Location:</h4>
                            <p><strong>Latitude:</strong> {{ answer.location.latitude }}</p>
                            <p><strong>Longitude:</strong> {{ answer.location.longitude }}</p>
                            <p><strong>Range:</strong> {{ answer.location.range }} meters</p>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No answers to display.</p>
        {% endif %}
</div>

    <script>
        
            // Function to fetch data based on plant_section
            async function fetchDataByPlantSection(plantSection) {
                try {
                    const response = await fetch(`/api/answered_questions?plant_section=${plantSection}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch data');
                    }
                    const data = await response.json();
                    updatePage(data);
                } catch (error) {
                    console.error('Error fetching data:', error);
                    document.getElementById('plant-section').innerText = 'Plant Section: Error loading data';
                }
            }
        
            // Function to update the page with fetched data
            function updatePage(data) {
                // Update header information
                document.getElementById('plant-section').innerText = `Plant Section: ${data[0].plant_section}`;
                document.getElementById('operator').innerText = data[0].operator;
                document.getElementById('timestamp').innerText = data[0].time_stamp;
        
                // Update questions and answers
                const questionsContainer = document.getElementById('questions-container');
                questionsContainer.innerHTML = ''; // Clear existing content
                data.forEach((question, index) => {
                    const answerBlock = document.createElement('div');
                    answerBlock.className = 'answer-block';
                    answerBlock.innerHTML = `
                        <p><strong>Question ${index + 1}:</strong> ${question.checklist_questions}</p>
                        <p><strong>Answer:</strong> ${question.checklist_answers}</p>
                    `;
                    questionsContainer.appendChild(answerBlock);
                });
        
                // Update location information
                document.getElementById('latitude').innerText = data[0].location.latitude;
                document.getElementById('longitude').innerText = data[0].location.longitude;
                document.getElementById('range').innerText = data[0].location.range;
            }
        
            // Event listener for plant section filter
            document.getElementById('plant-section-filter').addEventListener('change', function() {
                const selectedPlantSection = this.value;
                fetchDataByPlantSection(selectedPlantSection);
            });
        
            // Fetch initial data when the page loads
            window.onload = function() {
                const initialPlantSection = document.getElementById('plant-section-filter').value;
                fetchDataByPlantSection(initialPlantSection);
            };
        
        // Handle section change (send selected value to backend)
      document.getElementById('section').addEventListener('change', function() {
        let selectedValue = this.value;

        // Send data to Flask API
        fetch('/admin_create_checklist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ section: selectedValue })
        })
        .then(response => response.json())
        .then(data => {
            console.log("Server Response:", data);
            // Update the questions list dynamically
            const questionsList = document.getElementById('questions-list');
            questionsList.innerHTML = ''; // Clear the current list

            if (data.filtered_section && data.filtered_section.length > 0) {
              data.filtered_section.forEach(question => {
                const li = document.createElement('li');
                li.innerHTML = `
                  <label>
                    <input type="checkbox" name="question_id[]" value="${question.id}" /> 
                    # ${question.id} - ${question.plant_section} - ${question.question}
                  </label>
                `;
                questionsList.appendChild(li);
              });
            } else {
              const p = document.createElement('p');
              p.className = 'empty';
              p.innerText = 'There are no questions available for this section.';
              questionsList.appendChild(p);
            }
        })
        .catch(error => console.error("Error:", error));
      });
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  // Flash message timeout
setTimeout(() => {
    const flashMessage = document.getElementById("flash-message-container");
    if (flashMessage) {
        flashMessage.style.transition = "opacity 0.5s ease-out";
        flashMessage.style.opacity = "0";
        setTimeout(() => flashMessage.remove(), 500);
    }
}, 4000);

// Sidebar toggle script
document.addEventListener('DOMContentLoaded', function () {
    const toggleButton = document.getElementById('sidebarToggle');
    const sidebar = document.querySelector('.sidebar-content');

    if (toggleButton && sidebar) {
        toggleButton.addEventListener('click', function (e) {
            e.stopPropagation(); // Prevent document click
            sidebar.classList.toggle('active');
        });

        document.addEventListener('click', function (event) {
            if (!sidebar.contains(event.target) && event.target !== toggleButton) {
                sidebar.classList.remove('active');
            }
        });
    }
});
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    {% endblock %}
