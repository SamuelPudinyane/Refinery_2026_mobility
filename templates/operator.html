{% extends "base.html" %}
{% block title %}Checklist Form{% endblock %}

<div class="text-center py-3">
    <h5 class="navbar-brand">RAND REFINERY</h5>
</div>

{% block content %}
<h2 class="text-center my-3">Welcome back, {{ user.name }}</h2>
<div id="status" class="text-center p-2">
    <i class="fas fa-map-marker-alt me-2"></i>Checking your location...
</div>

<div id="questions-container container" style="display: none;">
    <form id="checklist-form" class="p-4">
        <div id="questions-wrapper"></div>
        <button type="submit" class="btn btn-success mt-3">
            <i class="fas fa-check-circle me-2"></i>Submit
        </button>
    </form>
    <a href="{{ url_for('logout') }}" class="btn btn-sm my-1">
        <i class="fas fa-right-from-bracket me-2"></i>LOGOUT
    </a>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const statusEl = document.getElementById('status');
        const questionsContainer = document.getElementById('questions-container');
        const questionsWrapper = document.getElementById('questions-wrapper');

        function renderQuestions(questions) {
            questionsWrapper.innerHTML = '';
            questions.forEach((q, idx) => {
                let html = `<div class="mb-3">
                    <label class="form-label">${idx + 1}. ${q.question}</label>`;

                if (q.question_type === "text") {
                    html += `<input type="text" class="form-control" name="answers[${q.id}]" required>`;
                } else if (q.question_type === "radio") {
                    q.options[0].forEach(option => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" 
                                       name="answers[${q.id}]" value="${option}" 
                                       data-reasoning="${q.reasoning}" 
                                       onchange="toggleReasonInput('${q.id}', '${option}')" required>
                                <label class="form-check-label">${option}</label>
                            </div>`;
                    });
                    if (q.reasoning) {
                        html += `<div class="reason-input mt-2" id="reason_${q.id}" style="display: none;">
                                    <input type="text" class="form-control" 
                                           name="reasons[${q.id}]" placeholder="Reason required">
                                 </div>`;
                    }
                }
                html += `</div>`;
                questionsWrapper.insertAdjacentHTML('beforeend', html);
            });
        }

        window.toggleReasonInput = function (id, selectedOption) {
            const reasonBox = document.getElementById(`reason_${id}`);
            const selected = document.querySelector(`input[name="answers[${id}]"]:checked`);
            if (!selected || !reasonBox) return;

            const required = selected.dataset.reasoning;
            reasonBox.style.display = ((required === "yes" && selectedOption === "YES") ||
                                       (required === "no" && selectedOption === "NO")) ? "block" : "none";
        }

        function getLocationAndCheck() {
            if (!navigator.geolocation) {
                statusEl.textContent = 'Geolocation not supported.';
                return;
            }
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                fetch('/operator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lon })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.is_within_range && data.operators_questions) {
                        renderQuestions(data.operators_questions);
                        questionsContainer.style.display = 'block';
                        statusEl.textContent = 'Location verified. Please complete the checklist below.';
                    } else {
                        statusEl.innerHTML = `<span class="text-danger">You are not within the allowed location range.</span>`;
                    }
                });
            }, err => {
                statusEl.textContent = 'Failed to get location.';
            }, { enableHighAccuracy: true, timeout: 7000 });
        }

        getLocationAndCheck();

        // Form submission
        const form = document.getElementById('checklist-form');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                const formData = new FormData(form);
                const answers = [];
                for (let [key, val] of formData.entries()) {
                    if (key.startsWith("answers[")) {
                        const id = key.match(/\d+/)[0];
                        const reason = formData.get(`reasons[${id}]`) || null;
                        const questionLabel = form.querySelector(`label[for="question_${id}"]`);
                        answers.push({
                            question: questionLabel ? questionLabel.textContent.trim() : "Unknown question",
                            answer: val,
                            reason: reason
                        });
                    }
                }

                fetch('/operator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lon, answers_with_questions: answers })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || 'Checklist submitted.');
                    if (data.status === 'success') window.location.reload();
                });
            });
        });
    });
</script>
{% endblock %}
